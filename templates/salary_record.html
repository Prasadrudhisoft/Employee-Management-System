<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salary Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #f5f4f0;
      --surface:  #ffffff;
      --border:   #e2e0da;
      --ink:      #1a1916;
      --muted:    #8a8880;
      --green:    #1a6644;
      --green-bg: #edf6f1;
      --red:      #b83232;
      --red-bg:   #fdf0f0;
      --amber:    #c47d0e;
      --amber-bg: #fef9ed;
      --blue:     #2356a8;
      --blue-bg:  #eef3fc;
      --radius:   10px;
      --shadow:   0 1px 3px rgba(0,0,0,.07), 0 4px 16px rgba(0,0,0,.05);
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--ink);
      color: #fff;
      padding: 0 32px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo {
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-dot {
      width: 8px; height: 8px;
      background: #7dffb3;
      border-radius: 50%;
      display: inline-block;
    }

    .header-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.78rem;
      color: rgba(255,255,255,.5);
    }

    #headerMonth {
      background: rgba(255,255,255,.1);
      border: none;
      color: #fff;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.78rem;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* â”€â”€ Page wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page { max-width: 1300px; margin: 0 auto; padding: 28px 24px 60px; }

    /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .top-bar {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .top-bar h2 {
      font-size: 1.35rem;
      font-weight: 800;
      letter-spacing: -0.4px;
    }

    .top-bar h2 small {
      display: block;
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--muted);
      margin-top: 2px;
      letter-spacing: 0;
    }

    .search-wrap {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-wrap input {
      background: var(--surface);
      border: 1px solid var(--border);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.82rem;
      padding: 8px 14px;
      border-radius: var(--radius);
      color: var(--ink);
      width: 200px;
      transition: border-color .2s;
    }
    .search-wrap input:focus { outline: none; border-color: var(--blue); }
    .search-wrap input::placeholder { color: var(--muted); }

    /* â”€â”€ Stats row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      box-shadow: var(--shadow);
    }

    .stat-card .label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 6px;
    }

    .stat-card .amount {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.25rem;
      font-weight: 500;
    }

    .stat-card.green .amount { color: var(--green); }
    .stat-card.red .amount   { color: var(--red); }
    .stat-card.blue .amount  { color: var(--blue); }

    /* â”€â”€ Table card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table-scroll { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      min-width: 1050px;
    }

    thead tr {
      background: #f9f8f5;
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 11px 14px;
      text-align: left;
      font-size: 0.70rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      white-space: nowrap;
    }

    th.section-earn  { color: var(--green); border-bottom: 2px solid var(--green); }
    th.section-deduct{ color: var(--red);   border-bottom: 2px solid var(--red); }
    th.section-net   { color: var(--blue);  border-bottom: 2px solid var(--blue); }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .15s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #fafaf8; }

    td {
      padding: 12px 14px;
      white-space: nowrap;
      vertical-align: middle;
    }

    .emp-name {
      font-weight: 700;
      font-size: 0.85rem;
    }
    .emp-id {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .mono {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
    }

    .earn-val  { color: var(--green); }
    .deduct-val{ color: var(--red);   }

    .gross-val {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
      color: var(--blue);
    }

    .net-val {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--ink);
      background: var(--blue-bg);
      padding: 4px 10px;
      border-radius: 6px;
      display: inline-block;
    }

    /* â”€â”€ Inline editable input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .deduct-input {
      background: var(--red-bg);
      border: 1px solid #e8c0c0;
      color: var(--red);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      padding: 5px 8px;
      border-radius: 6px;
      width: 90px;
      text-align: right;
      transition: border-color .2s, box-shadow .2s;
    }
    .deduct-input:focus {
      outline: none;
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(184,50,50,.12);
    }
    .deduct-input::placeholder { color: #d49090; }

    /* â”€â”€ Record button per row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .record-btn {
      background: var(--ink);
      color: #fff;
      border: none;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      letter-spacing: 0.3px;
      transition: opacity .2s, transform .1s;
      white-space: nowrap;
    }
    .record-btn:hover  { opacity: .78; }
    .record-btn:active { transform: scale(.97); }
    .record-btn:disabled { opacity: .35; cursor: not-allowed; }
    .record-btn.done {
      background: var(--green-bg);
      color: var(--green);
      border: 1px solid #b4d9c6;
    }

    /* â”€â”€ Empty / loading state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .state-box {
      padding: 80px 20px;
      text-align: center;
      color: var(--muted);
    }
    .state-box .icon {
      font-size: 2.4rem;
      margin-bottom: 12px;
      display: block;
    }
    .state-box p { font-size: 0.88rem; }

    .spinner {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid rgba(0,0,0,.1);
      border-top-color: var(--ink);
      border-radius: 50%;
      animation: spin .65s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 24px; right: 24px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 0.82rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(10px);
      transition: all .3s;
      pointer-events: none;
      z-index: 999;
      max-width: 300px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
    }
    #toast.show  { opacity: 1; transform: translateY(0); }
    #toast.ok    { background: var(--green-bg); color: var(--green); border: 1px solid #b4d9c6; }
    #toast.fail  { background: var(--red-bg);   color: var(--red);   border: 1px solid #e8c0c0; }

    /* â”€â”€ Month selector in header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #salaryMonthInput {
      background: var(--surface);
      border: 1px solid var(--border);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.82rem;
      padding: 7px 12px;
      border-radius: var(--radius);
      color: var(--ink);
    }

    @media(max-width:900px) {
      .stats-row { grid-template-columns: 1fr 1fr; }
    }
    @media(max-width:560px) {
      .stats-row { grid-template-columns: 1fr; }
      .top-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-dot"></span>
    PayRoll
  </div>
  <div class="header-meta">
    <span id="orgLabel">Loadingâ€¦</span>
  </div>
</header>

<div class="page">

  <!-- Top bar -->
  <div class="top-bar">
    <div>
      <h2>Salary Sheet
        <small id="pageSubtitle">Fetching employee recordsâ€¦</small>
      </h2>
    </div>
    <div class="search-wrap">
      <input type="month" id="salaryMonthInput" title="Salary Month for recording"/>
      <input type="text" id="searchBox" placeholder="Search employeeâ€¦" oninput="filterRows()"/>
    </div>
  </div>

  <!-- Stats row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="label">Employees</div>
      <div class="amount" id="statEmp">â€”</div>
    </div>
    <div class="stat-card green">
      <div class="label">Total Gross</div>
      <div class="amount" id="statGross">â€”</div>
    </div>
    <div class="stat-card red">
      <div class="label">Total Deductions</div>
      <div class="amount" id="statDeduct">â€”</div>
    </div>
    <div class="stat-card blue">
      <div class="label">Total Net Payable</div>
      <div class="amount" id="statNet">â€”</div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <div class="table-scroll">
      <table id="mainTable">
        <thead>
          <tr>
            <th rowspan="2">Employee</th>
            <th class="section-earn">Base</th>
            <th class="section-earn">AGP</th>
            <th class="section-earn">DA</th>
            <th class="section-earn">DP</th>
            <th class="section-earn">HRA</th>
            <th class="section-earn">TRA</th>
            <th class="section-earn">CLA</th>
            <th class="section-earn">Gross</th>
            <th class="section-deduct">PF</th>
            <th class="section-deduct">PT</th>
            <th class="section-deduct">Other Deduction</th>
            <th class="section-deduct">Absent Deduction</th>
            <th class="section-net">Net Payable</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="15">
              <div class="state-box">
                <span class="icon">â³</span>
                <p><span class="spinner"></span> Loading salary recordsâ€¦</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG â€“ change BASE_URL to your Flask server
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BASE_URL  = 'http://127.0.0.1:5000';
const TOKEN_KEY = 'token';

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getToken()      { return localStorage.getItem(TOKEN_KEY) || ''; }
function authHeaders()   { return { 'Content-Type':'application/json', 'Authorization':`Bearer ${getToken()}` }; }
function num(v)          { return parseFloat(v) || 0; }
function currency(n)     { return 'â‚¹' + Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

let toastTimer;
function toast(msg, type='ok') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.className = '', 3000);
}

/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let employees = []; // raw data from API

/* â”€â”€ Boot: set default month, fetch on load â”€â”€â”€ */
window.addEventListener('DOMContentLoaded', () => {
  const now  = new Date();
  const yyyy = now.getFullYear();
  const mm   = String(now.getMonth() + 1).padStart(2, '0');
  document.getElementById('salaryMonthInput').value = `${yyyy}-${mm}`;
  fetchSalaries();
});

/* â”€â”€ Fetch /get_salary_details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchSalaries() {
  try {
    const res  = await fetch(`${BASE_URL}/get_salary_details`, {
      method: 'GET',
      headers: authHeaders()
    });
    const data = await res.json();

    if (data.status === 'success') {
      employees = data.emp || [];
      document.getElementById('pageSubtitle').textContent =
        `${employees.length} employee${employees.length !== 1 ? 's' : ''} in your organisation`;
      document.getElementById('orgLabel').textContent = `Org Â· ${employees.length} staff`;
      renderTable(employees);
      updateStats(employees);
    } else {
      showError(data.message || 'Could not load records.');
    }
  } catch (err) {
    showError('Network error: ' + err.message);
  }
}

function showError(msg) {
  document.getElementById('tableBody').innerHTML = `
    <tr><td colspan="15">
      <div class="state-box">
        <span class="icon">âš ï¸</span>
        <p>${msg}</p>
      </div>
    </td></tr>`;
  document.getElementById('pageSubtitle').textContent = 'Failed to load records.';
}

/* â”€â”€ Render table rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTable(rows) {
  const tbody = document.getElementById('tableBody');

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="15"><div class="state-box"><span class="icon">ğŸ“­</span><p>No employees found.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map((emp, idx) => {
    const gross = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
    return `
    <tr data-idx="${idx}" data-userid="${emp.user_id}">
      <td>
        <div class="emp-name">${emp.Name || 'â€”'}</div>
        <div class="emp-id">${emp.user_id}</div>
      </td>
      <td class="mono earn-val">${currency(emp.base_salary)}</td>
      <td class="mono earn-val">${currency(emp.agp)}</td>
      <td class="mono earn-val">${currency(emp.da)}</td>
      <td class="mono earn-val">${currency(emp.dp)}</td>
      <td class="mono earn-val">${currency(emp.hra)}</td>
      <td class="mono earn-val">${currency(emp.tra)}</td>
      <td class="mono earn-val">${currency(emp.cla)}</td>
      <td><span class="gross-val">${currency(gross)}</span></td>

      <!-- Editable deductions -->
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="pf_${idx}" oninput="recalcRow(${idx})" title="Provident Fund"/></td>
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="pt_${idx}" oninput="recalcRow(${idx})" title="Professional Tax"/></td>
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="od_${idx}" oninput="recalcRow(${idx})" title="Other Deduction"/></td>
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="ad_${idx}" oninput="recalcRow(${idx})" title="Absent Days Deduction"/></td>

      <td><span class="net-val" id="net_${idx}">${currency(gross)}</span></td>

      <td>
        <button class="record-btn" id="rbtn_${idx}" onclick="recordSalary(${idx})">Record</button>
      </td>
    </tr>`;
  }).join('');
}

/* â”€â”€ Live recalc for a row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function recalcRow(idx) {
  const emp   = employees[idx];
  const gross = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
  const deduct = num(document.getElementById(`pf_${idx}`).value)
               + num(document.getElementById(`pt_${idx}`).value)
               + num(document.getElementById(`od_${idx}`).value)
               + num(document.getElementById(`ad_${idx}`).value);
  const net = gross - deduct;
  document.getElementById(`net_${idx}`).textContent = currency(net);
  updateStats(employees); // refresh totals
}

/* â”€â”€ Summary stats (uses live inputs) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateStats(rows) {
  let totalGross = 0, totalDeduct = 0;

  rows.forEach((emp, idx) => {
    const gross = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
    totalGross += gross;

    // Try reading live input values; fallback to 0 if row not rendered yet
    const pf = num(document.getElementById(`pf_${idx}`)?.value);
    const pt = num(document.getElementById(`pt_${idx}`)?.value);
    const od = num(document.getElementById(`od_${idx}`)?.value);
    const ad = num(document.getElementById(`ad_${idx}`)?.value);
    totalDeduct += (pf + pt + od + ad);
  });

  document.getElementById('statEmp').textContent   = rows.length;
  document.getElementById('statGross').textContent  = currency(totalGross);
  document.getElementById('statDeduct').textContent = currency(totalDeduct);
  document.getElementById('statNet').textContent    = currency(totalGross - totalDeduct);
}

/* â”€â”€ Search filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function filterRows() {
  const q = document.getElementById('searchBox').value.toLowerCase().trim();
  const filtered = q ? employees.filter(e => (e.Name || '').toLowerCase().includes(q)) : employees;

  // Re-render with filtered set (loses live inputs â€” acceptable for search)
  renderTable(filtered);
  updateStats(filtered);
}

/* â”€â”€ Record salary via /emp_salary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function recordSalary(idx) {
  const emp   = employees[idx];
  const month = document.getElementById('salaryMonthInput').value;

  if (!month) { toast('Please select a salary month first.', 'fail'); return; }

  const gross = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
  const pf    = num(document.getElementById(`pf_${idx}`).value);
  const pt    = num(document.getElementById(`pt_${idx}`).value);
  const od    = num(document.getElementById(`od_${idx}`).value);
  const ad    = num(document.getElementById(`ad_${idx}`).value);

  const payload = {
    user_id              : emp.user_id,
    salary_month         : month,
    salary_date          : new Date().toISOString().split('T')[0],
    base_salary          : num(emp.base_salary),
    agp                  : num(emp.agp),
    da                   : num(emp.da),
    dp                   : num(emp.dp),
    hra                  : num(emp.hra),
    tra                  : num(emp.tra),
    cla                  : num(emp.cla),
    pf,
    pt,
    other_deduction      : od,
    absent_days_deduction: ad
  };

  const btn = document.getElementById(`rbtn_${idx}`);
  btn.disabled    = true;
  btn.textContent = 'â€¦';

  try {
    const res  = await fetch(`${BASE_URL}/emp_salary`, {
      method : 'POST',
      headers: authHeaders(),
      body   : JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.status === 'success') {
      btn.textContent = 'âœ“ Done';
      btn.classList.add('done');
      toast(`${emp.Name} â€” salary recorded âœ“`, 'ok');
    } else {
      btn.disabled    = false;
      btn.textContent = 'Record';
      toast(data.message || 'Recording failed.', 'fail');
    }
  } catch (err) {
    btn.disabled    = false;
    btn.textContent = 'Record';
    toast('Network error: ' + err.message, 'fail');
  }
}
</script>
</body>
</html>