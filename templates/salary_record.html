<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salary Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #f5f4f0;
      --surface:  #ffffff;
      --border:   #e2e0da;
      --ink:      #1a1916;
      --muted:    #8a8880;
      --green:    #1a6644;
      --green-bg: #edf6f1;
      --red:      #b83232;
      --red-bg:   #fdf0f0;
      --amber:    #c47d0e;
      --amber-bg: #fef9ed;
      --blue:     #2356a8;
      --blue-bg:  #eef3fc;
      --radius:   10px;
      --shadow:   0 1px 3px rgba(0,0,0,.07), 0 4px 16px rgba(0,0,0,.05);
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    header {
      background: var(--ink);
      color: #fff;
      padding: 0 32px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .logo {
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-dot { width: 8px; height: 8px; background: #7dffb3; border-radius: 50%; display: inline-block; }
    .header-meta { display: flex; align-items: center; gap: 16px; font-size: 0.78rem; color: rgba(255,255,255,.5); }

    .page { max-width: 1400px; margin: 0 auto; padding: 28px 24px 100px; }

    .top-bar {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }
    .top-bar h2 { font-size: 1.35rem; font-weight: 800; letter-spacing: -0.4px; }
    .top-bar h2 small { display: block; font-size: 0.78rem; font-weight: 500; color: var(--muted); margin-top: 2px; letter-spacing: 0; }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .controls input {
      background: var(--surface);
      border: 1px solid var(--border);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.82rem;
      padding: 8px 14px;
      border-radius: var(--radius);
      color: var(--ink);
      transition: border-color .2s;
    }
    .controls input[type="text"] { width: 200px; }
    .controls input:focus { outline: none; border-color: var(--blue); }
    .controls input::placeholder { color: var(--muted); }

    .stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; box-shadow: var(--shadow); }
    .stat-card .label { font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
    .stat-card .amount { font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 500; }
    .stat-card.green .amount { color: var(--green); }
    .stat-card.red   .amount { color: var(--red); }
    .stat-card.blue  .amount { color: var(--blue); }

    .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .table-scroll { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; min-width: 1100px; }
    thead tr { background: #f9f8f5; border-bottom: 1px solid var(--border); }
    th { padding: 11px 14px; text-align: left; font-size: 0.70rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; white-space: nowrap; }
    th.section-earn   { color: var(--green); border-bottom: 2px solid var(--green); }
    th.section-deduct { color: var(--red);   border-bottom: 2px solid var(--red); }
    th.section-net    { color: var(--blue);  border-bottom: 2px solid var(--blue); }

    tbody tr { border-bottom: 1px solid var(--border); transition: background .15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #fafaf8; }
    td { padding: 12px 14px; white-space: nowrap; vertical-align: middle; }

    .emp-name { font-weight: 700; font-size: 0.85rem; }
    .emp-id { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
    .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }
    .earn-val { color: var(--green); }
    .gross-val { font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--blue); }
    .net-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 0.9rem; color: var(--ink); background: var(--blue-bg); padding: 4px 10px; border-radius: 6px; display: inline-block; }

    .deduct-input {
      background: var(--red-bg);
      border: 1px solid #e8c0c0;
      color: var(--red);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      padding: 5px 8px;
      border-radius: 6px;
      width: 90px;
      text-align: right;
      transition: border-color .2s, box-shadow .2s;
    }
    .deduct-input:focus { outline: none; border-color: var(--red); box-shadow: 0 0 0 3px rgba(184,50,50,.12); }
    .deduct-input::placeholder { color: #d49090; }

    /* Status badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.70rem;
      font-weight: 700;
      padding: 3px 9px;
      border-radius: 20px;
      letter-spacing: 0.3px;
    }
    .status-badge.saved   { background: var(--green-bg); color: var(--green); border: 1px solid #b4d9c6; }
    .status-badge.pending { background: var(--amber-bg); color: var(--amber); border: 1px solid #f0d89a; }

    /* Update button (per row) */
    .update-btn {
      background: var(--blue-bg);
      color: var(--blue);
      border: 1px solid #b8cef0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      letter-spacing: 0.3px;
      transition: background .2s, color .2s, transform .1s, opacity .2s;
      white-space: nowrap;
    }
    .update-btn:hover:not(:disabled) { background: var(--blue); color: #fff; }
    .update-btn:active:not(:disabled) { transform: scale(.97); }
    .update-btn:disabled { opacity: .3; cursor: not-allowed; }

    /* Bottom save bar */
    .save-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 14px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      z-index: 40;
      box-shadow: 0 -4px 20px rgba(0,0,0,.06);
    }
    .save-bar-info { font-size: 0.82rem; color: var(--muted); }
    .save-bar-info strong { color: var(--ink); font-weight: 700; }

    .save-all-btn {
      background: var(--ink);
      color: #fff;
      border: none;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      padding: 11px 28px;
      border-radius: var(--radius);
      cursor: pointer;
      letter-spacing: 0.3px;
      transition: opacity .2s, transform .1s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .save-all-btn:hover:not(:disabled)  { opacity: .82; }
    .save-all-btn:active:not(:disabled) { transform: scale(.98); }
    .save-all-btn:disabled { opacity: .4; cursor: not-allowed; }

    /* States */
    .state-box { padding: 80px 20px; text-align: center; color: var(--muted); }
    .state-box .icon { font-size: 2.4rem; margin-bottom: 12px; display: block; }
    .state-box p { font-size: 0.88rem; }

    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,.1); border-top-color: var(--ink); border-radius: 50%; animation: spin .65s linear infinite; vertical-align: middle; }
    .spinner.white { border-color: rgba(255,255,255,.25); border-top-color: #fff; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 80px; right: 24px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 0.82rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(10px);
      transition: all .3s;
      pointer-events: none;
      z-index: 999;
      max-width: 320px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok   { background: var(--green-bg); color: var(--green); border: 1px solid #b4d9c6; }
    #toast.fail { background: var(--red-bg);   color: var(--red);   border: 1px solid #e8c0c0; }

    @media(max-width:900px) { .stats-row { grid-template-columns: 1fr 1fr; } }
    @media(max-width:560px) { .stats-row { grid-template-columns: 1fr; } .top-bar { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>

<header>
  <div class="logo"><span class="logo-dot"></span> PayRoll</div>
  <div class="header-meta"><span id="orgLabel">Loading‚Ä¶</span></div>
</header>

<div class="page">

  <div class="top-bar">
    <div>
      <h2>Salary Sheet <small id="pageSubtitle">Fetching employee records‚Ä¶</small></h2>
    </div>
    <div class="controls">
      <input type="month" id="salaryMonthInput" title="Salary Month"/>
      <input type="text" id="searchBox" placeholder="Search employee‚Ä¶" oninput="filterRows()"/>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card">       <div class="label">Employees</div>       <div class="amount" id="statEmp">‚Äî</div></div>
    <div class="stat-card green"> <div class="label">Total Gross</div>     <div class="amount" id="statGross">‚Äî</div></div>
    <div class="stat-card red">   <div class="label">Total Deductions</div><div class="amount" id="statDeduct">‚Äî</div></div>
    <div class="stat-card blue">  <div class="label">Total Net Payable</div><div class="amount" id="statNet">‚Äî</div></div>
  </div>

  <div class="table-card">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Employee</th>
            <th class="section-earn">Base</th>
            <th class="section-earn">AGP</th>
            <th class="section-earn">DA</th>
            <th class="section-earn">DP</th>
            <th class="section-earn">HRA</th>
            <th class="section-earn">TRA</th>
            <th class="section-earn">CLA</th>
            <th class="section-earn">Gross</th>
            <th class="section-deduct">PF</th>
            <th class="section-deduct">PT</th>
            <th class="section-deduct">Other Deduction</th>
            <th class="section-deduct">Absent Deduction</th>
            <th class="section-net">Net Payable</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="16"><div class="state-box"><span class="icon">‚è≥</span><p><span class="spinner"></span> Loading‚Ä¶</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Fixed bottom Save All bar -->
<div class="save-bar">
  <div class="save-bar-info" id="saveBarInfo">Select a month to begin.</div>
  <button class="save-all-btn" id="saveAllBtn" onclick="saveAllSalaries()" disabled>
    üíæ Save All Salaries
  </button>
</div>

<div id="toast"></div>

<script>
const BASE_URL  = 'http://127.0.0.1:5000';
const TOKEN_KEY = 'token';

function getToken()    { return localStorage.getItem(TOKEN_KEY) || ''; }
function authHeaders() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` }; }
function num(v)        { return parseFloat(v) || 0; }
function currency(n)   { return '‚Çπ' + Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

let toastTimer;
function toast(msg, type = 'ok') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.className = '', 3500);
}

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let employees    = [];  // base salary details from /get_salary_details
let savedRecords = {};  // user_id ‚Üí record, for the currently selected month

/* ‚îÄ‚îÄ Boot ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  document.getElementById('salaryMonthInput').value =
    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

  document.getElementById('salaryMonthInput').addEventListener('change', fetchMonthlyRecords);

  fetchSalaries();
});

/* ‚îÄ‚îÄ Step 1: Load base salary details ‚îÄ‚îÄ */
async function fetchSalaries() {
  try {
    const res  = await fetch(`${BASE_URL}/get_salary_details`, { headers: authHeaders() });
    const data = await res.json();
    if (data.status === 'success') {
      employees = data.emp || [];
      document.getElementById('pageSubtitle').textContent =
        `${employees.length} employee${employees.length !== 1 ? 's' : ''} in your organisation`;
      document.getElementById('orgLabel').textContent = `Org ¬∑ ${employees.length} staff`;
      await fetchMonthlyRecords();
    } else {
      showError(data.message || 'Could not load records.');
    }
  } catch (err) {
    showError('Network error: ' + err.message);
  }
}

/* ‚îÄ‚îÄ Step 2: Load saved records for selected month ‚îÄ‚îÄ */
async function fetchMonthlyRecords() {
  const month = document.getElementById('salaryMonthInput').value;
  if (!month || !employees.length) return;

  savedRecords = {};
  try {
    const res  = await fetch(`${BASE_URL}/get_monthly_salary_records?salary_month=${month}`, { headers: authHeaders() });
    const data = await res.json();
    if (data.status === 'success') {
      (data.records || []).forEach(r => { savedRecords[r.user_id] = r; });
    }
  } catch (_) { /* non-fatal */ }

  renderTable(employees);
  updateStats(employees);
  updateSaveBar();
}

function showError(msg) {
  document.getElementById('tableBody').innerHTML =
    `<tr><td colspan="16"><div class="state-box"><span class="icon">‚ö†Ô∏è</span><p>${msg}</p></div></td></tr>`;
}

/* ‚îÄ‚îÄ Render rows ‚îÄ‚îÄ */
function renderTable(rows) {
  const tbody = document.getElementById('tableBody');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="16"><div class="state-box"><span class="icon">üì≠</span><p>No employees found.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map((emp, idx) => {
    const gross   = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
    const isSaved = !!savedRecords[emp.user_id];
    const rec     = savedRecords[emp.user_id] || {};

    // Pre-fill deduction inputs from saved record if this month is already saved
    const pfVal  = isSaved ? num(rec.pf)                   : '';
    const ptVal  = isSaved ? num(rec.pt)                   : '';
    const odVal  = isSaved ? num(rec.other_deduction)       : '';
    const adVal  = isSaved ? num(rec.absent_days_deduction) : '';
    const netVal = isSaved ? num(rec.net_salary)            : gross;

    const badge = isSaved
      ? `<span class="status-badge saved">‚úì Saved</span>`
      : `<span class="status-badge pending">Pending</span>`;

    // Update button: only active when salary is already saved for this month
    const updateDisabled = isSaved ? '' : 'disabled';
    const updateTitle    = isSaved ? 'Update this employee\'s saved salary' : 'Save salary first to enable update';

    return `
    <tr data-userid="${emp.user_id}">
      <td>
        <div class="emp-name">${emp.Name || '‚Äî'}</div>
        <div class="emp-id">${emp.user_id}</div>
      </td>
      <td class="mono earn-val">${currency(emp.base_salary)}</td>
      <td class="mono earn-val">${currency(emp.agp)}</td>
      <td class="mono earn-val">${currency(emp.da)}</td>
      <td class="mono earn-val">${currency(emp.dp)}</td>
      <td class="mono earn-val">${currency(emp.hra)}</td>
      <td class="mono earn-val">${currency(emp.tra)}</td>
      <td class="mono earn-val">${currency(emp.cla)}</td>
      <td><span class="gross-val">${currency(gross)}</span></td>

      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="pf_${idx}" value="${pfVal}" oninput="recalcRow(${idx})" title="Provident Fund"/></td>
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="pt_${idx}" value="${ptVal}" oninput="recalcRow(${idx})" title="Professional Tax"/></td>
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="od_${idx}" value="${odVal}" oninput="recalcRow(${idx})" title="Other Deduction"/></td>
      <td><input class="deduct-input" type="number" min="0" step="0.01" placeholder="0.00"
            id="ad_${idx}" value="${adVal}" oninput="recalcRow(${idx})" title="Absent Days Deduction"/></td>

      <td><span class="net-val" id="net_${idx}">${currency(netVal)}</span></td>
      <td id="status_${idx}">${badge}</td>
      <td>
        <button class="update-btn" id="ubtn_${idx}" ${updateDisabled} title="${updateTitle}"
          onclick="updateSalary(${idx})">‚Üë Update</button>
      </td>
    </tr>`;
  }).join('');
}

/* ‚îÄ‚îÄ Live net recalc ‚îÄ‚îÄ */
function recalcRow(idx) {
  const emp   = employees[idx];
  const gross = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
  const d     = num(document.getElementById(`pf_${idx}`).value)
              + num(document.getElementById(`pt_${idx}`).value)
              + num(document.getElementById(`od_${idx}`).value)
              + num(document.getElementById(`ad_${idx}`).value);
  document.getElementById(`net_${idx}`).textContent = currency(gross - d);
  updateStats(employees);
}

/* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
function updateStats(rows) {
  let totalGross = 0, totalDeduct = 0;
  rows.forEach((emp, idx) => {
    const gross = num(emp.base_salary) + num(emp.agp) + num(emp.da) + num(emp.dp) + num(emp.hra) + num(emp.tra) + num(emp.cla);
    totalGross += gross;
    totalDeduct += num(document.getElementById(`pf_${idx}`)?.value)
                 + num(document.getElementById(`pt_${idx}`)?.value)
                 + num(document.getElementById(`od_${idx}`)?.value)
                 + num(document.getElementById(`ad_${idx}`)?.value);
  });
  document.getElementById('statEmp').textContent    = rows.length;
  document.getElementById('statGross').textContent  = currency(totalGross);
  document.getElementById('statDeduct').textContent = currency(totalDeduct);
  document.getElementById('statNet').textContent    = currency(totalGross - totalDeduct);
}

/* ‚îÄ‚îÄ Save bar label + button state ‚îÄ‚îÄ */
function updateSaveBar() {
  const month    = document.getElementById('salaryMonthInput').value || '‚Äî';
  const nSaved   = Object.keys(savedRecords).length;
  const nPending = employees.length - nSaved;
  const btn      = document.getElementById('saveAllBtn');
  const info     = document.getElementById('saveBarInfo');

  if (employees.length === 0) {
    info.innerHTML = 'No employees loaded.';
    btn.disabled = true;
    return;
  }

  if (nPending === 0) {
    // All saved ‚Üí disable Save All, only Update available
    info.innerHTML = `All <strong>${employees.length}</strong> employees already have salary saved for <strong>${month}</strong>. Use <strong>Update</strong> to make changes.`;
    btn.disabled = true;
    btn.innerHTML = '‚úì All Saved';
  } else {
    info.innerHTML = `<strong>${nPending}</strong> unsaved ¬∑ <strong>${nSaved}</strong> already saved for <strong>${month}</strong>`;
    btn.disabled = false;
    btn.innerHTML = 'üíæ Save All Salaries';
  }
}

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
function filterRows() {
  const q = document.getElementById('searchBox').value.toLowerCase().trim();
  renderTable(q ? employees.filter(e => (e.Name || '').toLowerCase().includes(q)) : employees);
  updateStats(employees);
}

/* ‚îÄ‚îÄ Save All: calls original /emp_salary once per employee ‚îÄ‚îÄ */
async function saveAllSalaries() {
  const month = document.getElementById('salaryMonthInput').value;
  if (!month) { toast('Please select a salary month first.', 'fail'); return; }

  const btn = document.getElementById('saveAllBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner white"></span> Saving‚Ä¶';

  // Only send employees that are NOT yet saved for this month
  const pending = employees.filter(emp => !savedRecords[emp.user_id]);

  let savedCount = 0;
  for (let idx = 0; idx < employees.length; idx++) {
    const emp = employees[idx];
    if (savedRecords[emp.user_id]) continue; // already saved, skip

    const payload = {
      user_id              : emp.user_id,
      salary_month         : month,
      salary_date          : new Date().toISOString().split('T')[0],
      base_salary          : num(emp.base_salary),
      agp                  : num(emp.agp),
      da                   : num(emp.da),
      dp                   : num(emp.dp),
      hra                  : num(emp.hra),
      tra                  : num(emp.tra),
      cla                  : num(emp.cla),
      pf                   : num(document.getElementById(`pf_${idx}`)?.value),
      pt                   : num(document.getElementById(`pt_${idx}`)?.value),
      other_deduction      : num(document.getElementById(`od_${idx}`)?.value),
      absent_days_deduction: num(document.getElementById(`ad_${idx}`)?.value)
    };

    try {
      const res  = await fetch(`${BASE_URL}/emp_salary`, {
        method : 'POST',
        headers: authHeaders(),
        body   : JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.status === 'success') savedCount++;
    } catch (_) {}
  }

  toast(`${savedCount} of ${pending.length} salary records saved.`, savedCount > 0 ? 'ok' : 'fail');

  // Refresh monthly records to update badges and enable Update buttons
  await fetchMonthlyRecords();
}

/* ‚îÄ‚îÄ Update single employee salary ‚îÄ‚îÄ */
async function updateSalary(idx) {
  const emp   = employees[idx];
  const month = document.getElementById('salaryMonthInput').value;

  if (!savedRecords[emp.user_id]) {
    toast('No saved record for this employee. Use Save All first.', 'fail');
    return;
  }

  const btn = document.getElementById(`ubtn_${idx}`);
  btn.disabled = true;
  btn.textContent = '‚Ä¶';

  const payload = {
    user_id              : emp.user_id,
    salary_month         : month,
    base_salary          : num(emp.base_salary),
    agp                  : num(emp.agp),
    da                   : num(emp.da),
    dp                   : num(emp.dp),
    hra                  : num(emp.hra),
    tra                  : num(emp.tra),
    cla                  : num(emp.cla),
    pf                   : num(document.getElementById(`pf_${idx}`).value),
    pt                   : num(document.getElementById(`pt_${idx}`).value),
    other_deduction      : num(document.getElementById(`od_${idx}`).value),
    absent_days_deduction: num(document.getElementById(`ad_${idx}`).value)
  };

  try {
    const res  = await fetch(`${BASE_URL}/update_emp_salary`, {
      method : 'PUT',
      headers: authHeaders(),
      body   : JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.status === 'success') {
      toast(`${emp.Name} ‚Äî salary updated ‚úì`, 'ok');
      btn.textContent = '‚úì Updated';
      setTimeout(() => { btn.disabled = false; btn.textContent = '‚Üë Update'; }, 2000);
    } else {
      toast(data.message || 'Update failed.', 'fail');
      btn.disabled = false;
      btn.textContent = '‚Üë Update';
    }
  } catch (err) {
    toast('Network error: ' + err.message, 'fail');
    btn.disabled = false;
    btn.textContent = '‚Üë Update';
  }
}
</script>
</body>
</html>